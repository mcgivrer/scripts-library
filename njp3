#!/bin/bash
# New Java project script generation
# Version: 1.0
# Author: Frédéric Delorme <frederic.delorme@gmail.com>
# Date: 2025-07-25
# 
# This script creates a new Java project with a specified structure,
# including directories for source code, resources, tests, and documentation.
# It also initializes a Git repository, sets up a README file, and configures
# the project for use with VSCode and SDKMAN.
# This script is designed to be run in a Unix-like environment with bash.
#
# MIT License
# 
# Copyright (c) 2025 Frédéric Delorme <frederic.delorme@gmail.com>
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
# 

# Fonction pour afficher l'utilisation du script
usage() {
    echo "Usage: $0 [-p <PROJECT_APP_NAME>] [-j <PROJECT_JAVA_VERSION>] [-a <author_name>] [-e <author_email>] [-r <remote_repo_url>] [-f|--frame] [--help]"
    echo ""
    echo "Options:"
    echo " -p, --project <PROJECT_APP_NAME>            Nom du projet à créer (par défaut: myapp)"
    echo " -n, --name <application_name>               Application name (default: capitalized project name)"
    echo " -j, --java <PROJECT_JAVA_VERSION>           Version de Java à utiliser (par défaut: 24-zulu)"
    echo " -a, --author-name <GIT_AUTHOR_NAME>         Nom de l'auteur Git (par défaut: Default Author)"
    echo " -e, --author-email <GIT_AUTHOR_EMAIL>       Email de l'auteur Git (par défaut: default@example.com)"
    echo " -r, --remote <REMOTE_REPO_URL>              URL du dépôt distant pour le push (facultatif)"
    echo " -pk, --package <PROJECT_PACKAGE_NAME>       Nom du package (par défaut: core)"
    echo " -mc, --main-class <PROJECT_MAIN_CLASS_NAME> Nom de la classe principale (par défaut: App)"
    echo " -f, --frame                                 Crée une application avec une fenêtre (par défaut: non)"
    echo " -t, --template <App_CLASS_TEMPLATE>         Path to the application template (optional)"
    echo " -v, --version <PROJECT_JAVA_VERSION>        Numéro de version de départ pour le projet (par défaut: 0.0.1)"
    echo " -vd, --vendor-name <PROJECT_VENDOR_NAME>    Nom du fournisseur (par défaut: MyVendorName)"
    echo " --help                                      Affiche cette aide"
    echo ""
    echo "Examples:"
    echo ""
    echo "1). Generate a frame based java application named 'my_project' with java 17:"
    echo ""
    echo "$0 -p my_project -n MyProject -j 17-zulu \\"
    echo " -a \"John Doe\" -e \"john.doe@mymail.com\" \\"
    echo " -r \"https://github.com/jdoe/my_git_project.git\" \\"
    echo " -pk \"com.core.demo\" -mc \"ApplicationDemo\" \\"
    echo " -f -vd MyOwnCompany"
    echo ""
    echo "This command line will create a java project based on java 17, "
    echo "named 'my_project' containing a main class 'com.core.demo.ApplicationDemo'"
    echo "with a JFrame application and the application name displayed will be 'MyProject'."
    echo ""
    echo "2). Generate a Game with a FPS based game loop named 'ArcadeDemo' with java 24:"
    echo ""
    echo "$0 -p arcadedemo -n ArcadeDemo -j 24-zulu \\"
    echo " -a \"John Doe\" -e \"john.doe@mymail.com\" \\"
    echo " -r \"https://github.com/jdoe/my_git_project.git\" \\"
    echo " -pk \"com.core.arcade.demo\" -mc \"GameApp\" \\"
    echo " -t ~/scripts/templates/App_GameFPS_template.java \\"
    echo " -vd MyOwnCompany"
    echo ""
    echo "This command line will create a java project based on java 24, "
    echo "named 'arcadedemo' containing a main class 'com.core.arcade.demo.GameApp'"
    echo "with a game loop application and the application name displayed will be 'ArcadeDemo'."
    echo "---"
    exit 1
}

# Valeurs par défaut

export APPLICATION_NAME=
export PROJECT_APP_NAME="myapp"
export PROJECT_JAVA_VERSION="24-zulu"
export PROJECT_APP_VERSION=0.0.1
export GIT_AUTHOR_NAME="Default Author"
export GIT_AUTHOR_EMAIL="default@example.com"
export REMOTE_REPO_URL=""
export PROJECT_PACKAGE_NAME="core"
export PROJECT_MAIN_CLASS_NAME="App"
export PROJECT_VENDOR_NAME="MyVendorName"
export JUNIT_VERSION="1.13.4"

# Analyse des arguments²
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--name)
            APPLICATION_NAME="$2"
            shift 2
            ;;
        -p|--project)
            PROJECT_APP_NAME="$2"
            if [[ -n "${APPLICATION_NAME}" ]]; then
               # Application's name will be project's name capitalized.
               export APPLICATION_NAME=${PROJECT_APP_NAME^};
            fi
            shift 2
            ;;
        -j|--java)
            PROJECT_JAVA_VERSION="$2"
            shift 2
            ;;
        -a|--author-name)
            GIT_AUTHOR_NAME="$2"
            shift 2
            ;;
        -e|--author-email)
            GIT_AUTHOR_EMAIL="$2"
            shift 2
            ;;
        -r|--remote)
            REMOTE_REPO_URL="$2"
            shift 2
            ;;
        -pk|--package)
            PROJECT_PACKAGE_NAME="$2"
            shift 2
            ;;
        -f|--frame)
            FRAME=true
            shift 1
            ;;       
        -t|--template)
            APP_TEMPLATE="$2"
            shift 2
            ;;
        -mc|--main-class)
            PROJECT_MAIN_CLASS_NAME="$2"
            shift 2
            ;;
        -v|--version)
            PROJECT_APP_VERSION="$2"
            shift 2
            ;;
        -vd|--vendor)
            PROJECT_VENDOR_NAME="$2"
            shift 2
            ;;
        --help)
            usage
            ;;
        *)
            usage
            ;;
    esac
done

# Création du projet
mkdir -p "${PROJECT_APP_NAME}"/{src/{{main,test}/{java,resources},docs},libs,target/build}

echo """
# ${PROJECT_APP_NAME}

**Version:** ${PROJECT_APP_VERSION}  
**Author:** ${GIT_AUTHOR_NAME} <${GIT_AUTHOR_EMAIL}>  
**Vendor:** ${PROJECT_VENDOR_NAME}

## Description

This project is ${PROJECT_APP_NAME}.

## Build

To build the project, use the provided \`build\` script:

\`\`\`bash
./build
\`\`\`

Or for a full build with tests, docs, and sources:

\`\`\`bash
./build c b m j t d s
\`\`\`

- **c**: clean
- **b**: build sources
- **m**: create manifest
- **j**: create JAR
- **t**: run unit tests
- **d**: generate Javadoc
- **s**: generate sources JAR

## Run

After building, run the application with:

\`\`\`bash
./build r
\`\`\`

The generated JAR will be in \`target/build/${PROJECT_APP_NAME}-${PROJECT_PACKAGE_NAME}.${PROJECT_MAIN_CLASS_NAME}-${PROJECT_APP_VERSION}.jar\`.

## Project Structure

- \`src/main/java\`: Application sources
- \`src/main/resources\`: Resources
- \`src/test/java\`: Test sources
- \`src/test/resources\`: Test resources
- \`libs\`: External libraries
- \`target\`: Build output

## Requirements

- Java ${PROJECT_JAVA_VERSION}
- Bash, Git

---

by ${GIT_AUTHOR_NAME} <${GIT_AUTHOR_EMAIL}>
""" | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/README.md

echo "target/" | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/.gitignore
echo "java=${PROJECT_JAVA_VERSION}" | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/.sdkmanrc
curl -sL https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/$JUNIT_VERSION/junit-platform-console-standalone-$JUNIT_VERSION.jar > "${PROJECT_APP_NAME}"/libs/junit-platform-console-standalone-$JUNIT_VERSION.jar
curl -sL https://gist.githubusercontent.com/mcgivrer/b95bf476b8494c180c0a386a5ae11264/raw/ > "${PROJECT_APP_NAME}"/build
sed -i "s/\[PROJECT_APP_NAME\]/${APPLICATION_NAME}/g" "${PROJECT_APP_NAME}"/build
sed -i "s/\[PROJECT_APP_VERSION\]/${PROJECT_APP_VERSION}/g" "${PROJECT_APP_NAME}"/build
sed -i "s/\[PROJECT_PACKAGE_NAME\]/${PROJECT_PACKAGE_NAME}/g" "${PROJECT_APP_NAME}"/build
sed -i "s/\[PROJECT_MAIN_CLASS_NAME\]/${PROJECT_MAIN_CLASS_NAME}/g" "${PROJECT_APP_NAME}"/build
sed -i "s/\[PROJECT_VENDOR_NAME\]/${PROJECT_VENDOR_NAME}/g" "${PROJECT_APP_NAME}"/build
sed -i "s/\[GIT_AUTHOR_NAME\]/${GIT_AUTHOR_NAME}/g" "${PROJECT_APP_NAME}"/build
sed -i "s/\[GIT_AUTHOR_EMAIL\]/${GIT_AUTHOR_EMAIL}/g" "${PROJECT_APP_NAME}"/build
chmod +x "${PROJECT_APP_NAME}"/build

# integrate VSCode support
mkdir -p "${PROJECT_APP_NAME}/.vscode";\
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}/.vscode/settings.json"
{
    "java.format.settings.url": ".vscode/java-formatter.xml",
    "java.project.sourcePaths": [
        "src/main/java",
        "src/main/resources",
        "src/test/java",
        "src/test/resources"
    ],
    "java.project.encoding": "warning",
    "java.project.referencedLibraries": [
        "libs/junit-platform-console-standalone-1.12.2.jar"
    ],
    "java.project.outputPath": "target/classes"
}
EOL
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}/.vscode/launch.json"
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "type": "java",
            "name": "Current File",
            "request": "launch",
            "mainClass": "${file}"
        },
        {
            "type": "java",
            "name": "App",
            "request": "launch",
            "mainClass": "App",
            "projectName": "${PROJECT_APP_NAME}_53c24221"
        }
    ]
}
EOL
# create documentation
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/src/docs/00-preface.md
# Project ${PROJECT_APP_NAME}

## Preface

This is the preface for the documentation of the project ${PROJECT_APP_NAME}.
You must rewrite this document according to your specifications.

>[!NOTE]
>Please us the markdown text format to easily create 
>docs in multiple format with the 'pandoc' tool. 

${GIT_AUTHOR_NAME} ${GIT_AUTHOR_EMAIL}
EOL
# create configuration file
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/src/main/resources/config.properties
app.debug=0
app.mode=DEVELOPMENT
EOL
# create translation file
mkdir -p "${PROJECT_APP_NAME}"/src/main/resources/i18n
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/src/main/resources/i18n/messages.properties
app.name=${PROJECT_APP_NAME}
app.version=1.0.0
EOL
# Générer le fichier en utilisant envsubst
if [[ -n "${FRAME}" || -n "${APP_TEMPLATE}" ]]; then
    cat <<EOL >> "${PROJECT_APP_NAME}/src/main/resources/i18n/messages.properties"
app.message.welcome=Welcome into ${APPLICATION_NAME} (${PROJECT_APP_VERSION}) application.
app.message.exit=Press [ESCAPE] to exit....
EOL
fi
# create a basic application class into a core package.

mkdir -p "${PROJECT_APP_NAME}"/src/main/java/${PROJECT_PACKAGE_NAME//.//}
# Générer le fichier en utilisant envsubst
if [[ -n "${FRAME}" ]]; then
    envsubst < ~/scripts/templates/App_Frame_template.java | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/src/main/java/${PROJECT_PACKAGE_NAME//.//}/${PROJECT_MAIN_CLASS_NAME}.java
else
    envsubst < ~/scripts/templates/App_template.java | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/src/main/java/${PROJECT_PACKAGE_NAME//.//}/${PROJECT_MAIN_CLASS_NAME}.java
fi

if [[ -n "${APP_TEMPLATE}" ]]; then
    envsubst < ${APP_TEMPLATE} | iconv -f UTF-8 -t UTF-8 > "${PROJECT_APP_NAME}"/src/main/java/${PROJECT_PACKAGE_NAME//.//}/${PROJECT_MAIN_CLASS_NAME}.java
fi
## create git repository
git init -b main --quiet "${PROJECT_APP_NAME}"/
git -C "${PROJECT_APP_NAME}" config user.name "${GIT_AUTHOR_NAME}"
git -C "${PROJECT_APP_NAME}" config user.email "${GIT_AUTHOR_EMAIL}"
git -C "${PROJECT_APP_NAME}" add .
git -C "${PROJECT_APP_NAME}" commit -m "Create Project ${PROJECT_APP_NAME}"

# Pousser vers le dépôt distant si l'URL est fournie
if [[ -n "${REMOTE_REPO_URL}" ]]; then
    git -C "${PROJECT_APP_NAME}" remote add origin "${REMOTE_REPO_URL}"
    git -C "${PROJECT_APP_NAME}" push -f origin main
fi
