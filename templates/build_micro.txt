#!/bin/bash
#---- project parameters
project_name={{PROJECT_NAME:MyProject}}
project_version={{PROJECT_VERSION:1.0.0}}
main_class={{MAIN_CLASS:core.App}}
JARS={{JARS:dep/*.jar}}
vendor_name={{VENDOR_NAME:"DemoTest Inc."}}
author_name={{AUTHOR_NAME:"Frédéric Delorme<frederic.delorme@gmail.com>"}}
#
#--- DO NOT CHANGE THE FOLLOWING LINES ---
#
#
#--- DO NOT CHANGE THE FOLLOWING LINES ---
#
SRC=./src
LIBS=./libs
LWJGL_DIR=./libs/dep
TARGET=./target
BUILD=${TARGET}/build
CLASSES=${TARGET}/classes
RESOURCES=${SRC}/main/resources
SOURCE_ENCODING="UTF-8"
SOURCE_VERSION="25"
COMPILATION_OPTS="-Xlint:unchecked -Xlint:deprecation -parameters"
JAR_OPTS="--enable-native-access=ALL-UNNAMED -Xmx512m"
JUNIT_VERSION=6.0.1
# add your test execution commands here
TEST_CLASSES=${TARGET}/test-classes
TEST_RESOURCES=${SRC}/test/resources
LIB_TEST=$LIBS/junit-platform-console-standalone-$JUNIT_VERSION.jar
# detect OS type to set the classpath separator
if [[ "$OSTYPE" == "linux"* ]]; then
  FS=":"
  NATIVES_PLATFORM="natives-linux"
else
  FS=";"
  NATIVES_PLATFORM="natives-windows"
fi
# define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'
#---- process buid
GIT_COMMIT_ID=$(git rev-parse HEAD)
JAVA_BUILD=$(java --version | head -1 | cut -f2 -d' ')

echo "Building LWJGL classpath..."
LWJGL_CP=""
for jar in ${LWJGL_DIR}/*.jar; do
  # Skip natives JARs for compilation
  if [[ ! "$jar" =~ "natives" ]]; then
    if [ -z "$LWJGL_CP" ]; then
      LWJGL_CP="$jar"
    else
      LWJGL_CP="${LWJGL_CP}${FS}${jar}"
    fi
  fi
done
echo "LWJGL Classpath: ${LWJGL_CP}"

if( [ "$1" == "compile" ] ); then

  # Prepare Build
  echo ---
  echo "Prepare build for ${project_name} version ${project_version}..."
  rm -vrf target/
  find $SRC/main/java $RESOURCES -name "*.java"
  mkdir -vp ${TARGET}/{classes,build/libs}
  echo "done."
  echo ---
  echo "compile sources..."
  echo "> from : ${SRC}/main/java"
  # Compile sources
  ${COMPILATION_OPTS} -cp "${LWJGL_CP}" $(find $SRC/main/java $RESOURCES -name "*.java") -d ${CLASSES}
  # create MANIFEST file
  cp -vr $RESOURCES/* $CLASSES
  echo "done."
fi
echo ---
if( [ "$1" == "jar" ] ); then
  echo "create jar..."
  if( [ -z "$JARS" ] ); then
    EXTERNAL_JARS=""
  else
    EXTERNAL_JARS=$(find $JARS -name "*.jar" | tr '\n' $FS | sed 's/.$//')
  fi
  for app in ${main_class}
  do
    mkdir -p $TARGET/META-INF
    echo "}} for ${project_name}.$app..."
    echo """
  Manifest-Version: ${project_name}
  Main-Class: ${app}
  Class-Path: ${JARS}
  Created-By: ${JAVA_BUILD}
  Implementation-Title: ${project_name}
  Implementation-Version: ${project_version}-build_${GIT_COMMIT_ID:0:12}
  Implementation-Vendor: ${vendor_name}
  Implementation-Author: ${author_name}
  """ }}target/META-INF/MANIFEST.MF
    jar cvfe target/build/${project_name}-$app-${project_version}.jar $app -C target/classes .
    echo "done."
  done
fi
if( [ "$1" == "test" ] ); then
  echo "Run tests..."

  echo -e "|_ ${BLUE}6. Execute tests${NC}..."
  echo "> from : ${SRC}/test"
  echo "> to   : ${TARGET}/test-classes"
  mkdir -p ${TARGET}/test-classes
  echo "copy test resources"
  cp -r ./$RESOURCES/* $TEST_CLASSES
  cp -r ./$TEST_RESOURCES/* $TEST_CLASSES
  echo "compile test classes"
  #list test sources
  find ${SRC}/main -name '*.java' >${TARGET}/sources.lst
  find ${SRC}/test -name '*.java' >${TARGET}/test-sources.lst
  javac -source $SOURCE_VERSION -encoding $SOURCE_ENCODING $COMPILATION_OPTS -cp ".${FS}$LIB_TEST${FS}${LWJGL_CP}" -d $TEST_CLASSES @${TARGET}/sources.lst @${TARGET}/test-sources.lst
  echo "execute tests through JUnit"
  java $JAR_OPTS -jar $LIB_TEST execute -cp "${LWJGL_CP}${FS}${CLASSES}${FS}${TEST_CLASSES}${FS}." --scan-class-path
  echo -e "   |_ ${GREEN}done$NC"
  echo "- execute tests through JUnit ${SRC}/test." }}${TARGET}/build.log
fi

## Run produces JAR if required.
if( [ "$1" == "run" ] ); then
  echo "Running application with LWJGL support..."

  # Build complete classpath including all LWJGL JARs
  RUN_CP=""
  for jar in ${LWJGL_DIR}/*.jar; do
    if [ -z "$RUN_CP" ]; then
      RUN_CP="$jar"
    else
      RUN_CP="${RUN_CP}${FS}${jar}"
    fi
  done

  # Add classes directory
  RUN_CP="${CLASSES}${FS}${RUN_CP}"

  echo "Running ${main_class}..."
  echo "Native library path: ${LWJGL_DIR}"
  echo "java --enable-preview --enable-native-access=ALL-UNNAMED -Djava.library.path=\"${LWJGL_DIR}\" -cp \"${RUN_CP}\" ${main_class}"
  java --enable-preview --enable-native-access=ALL-UNNAMED -Djava.library.path="${LWJGL_DIR}" -cp "${RUN_CP}" ${main_class} $2
  echo ""
  echo "done."
fi

if( [ "$1" == "all" ] ); then
  bash build
  bash build compile
  bash build jar
  bash build test
  bash build run
fi

if( [ "$1" == "clean" ] ); then
  echo "Clean build files..."
  rm -vrf target/
  echo "done."
fi

if( [ "$1" == "help" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] ); then
  echo "Build script for ${project_name} version ${project_version}"
  echo "Usage: bash build [option]"
  echo "  options:"
  echo "    all    : build, test and run"
  echo "    test   : execute unit tests"
  echo "    run    : run the generated JAR(s)"
  echo "    clean  : remove build files"
  echo "    help   : display this help"
fi
