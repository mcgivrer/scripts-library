#!/bin/bash
# New Java project script generation
# Version: 1.0
# Author: Frédéric Delorme <frederic.delorme@gmail.com>
# Date: 2025-07-25
# 
# This script creates a new Java project with a specified structure,
# including directories for source code, resources, tests, and documentation.
# It also initializes a Git repository, sets up a README file, and configures
# the project for use with VSCode and SDKMAN.
# This script is designed to be run in a Unix-like environment with bash.
#
# MIT License
# 
# Copyright (c) 2025 Frédéric Delorme <frederic.delorme@gmail.com>
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
# 

# Fonction pour afficher l'utilisation du script
usage() {
    echo "Usage: $0 [-p <project_name>] [-j <java_version>] [-a <author_name>] [-e <author_email>] [-r <remote_repo_url>] [-f|--frame] [--help]"
    echo ""
    echo "Options:"
    echo "  -p, --project <project_name>        Nom du projet à créer (par défaut: myapp)"
    echo "  -j, --java <java_version>           Version de Java à utiliser (par défaut: 24-zulu)"
    echo "  -a, --author-name <author_name>     Nom de l'auteur Git (par défaut: Default Author)"
    echo "  -e, --author-email <author_email>   Email de l'auteur Git (par défaut: default@example.com)"
    echo "  -r, --remote <remote_repo_url>      URL du dépôt distant pour le push (facultatif)"
    echo "  -pk, --package <package_name>       Nom du package (par défaut: core)"
    echo "  -mc, --main-class <main_class_name> Nom de la classe principale (par défaut: App)"
    echo "  -f, --frame                         Crée une application avec une fenêtre (par défaut: non)"
    echo "  --help                              Affiche cette aide"
    echo ""
    echo "Exemple:"
    echo "  $0 -p mon_projet -j 17-zulu -a \"Jean Dupont\" -e \"jean.dupont@example.com\" -r \"https://github.com/username/repo.git\" -pk \"core\" -mc \"App\""
    exit 1
}

# Valeurs par défaut
export PROJECT_NAME="myapp"
export JAVA_VERSION="24-zulu"
export APP_VERSION=0.0.1
export GIT_AUTHOR_NAME="Default Author"
export GIT_AUTHOR_EMAIL="default@example.com"
export VENDOR_NAME="vendor name"
export REMOTE_REPO_URL=""
export PACKAGE_NAME="core"
export MAIN_CLASS_NAME="App"

# Analyse des arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--project)
            PROJECT_NAME="$2"
            shift 2
            ;;
        -j|--java)
            JAVA_VERSION="$2"
            shift 2
            ;;
        -a|--author-name)
            GIT_AUTHOR_NAME="$2"
            shift 2
            ;;
        -e|--author-email)
            GIT_AUTHOR_EMAIL="$2"
            shift 2
            ;;
        -r|--remote)
            REMOTE_REPO_URL="$2"
            shift 2
            ;;
        -pk|--package)
            PACKAGE_NAME="$2"
            shift 2
            ;;
        -f|--frame)
            FRAME=true
            shift 1
            ;;
        -mc|--main-class)
            MAIN_CLASS_NAME="$2"
            shift 2
            ;;
        -v|--version)
            APP_VERSION="$2"
            shift 2
            ;;
        --help)
            usage
            ;;
        *)
            usage
            ;;
    esac
done

# Création du projet
mkdir -p "${PROJECT_NAME}"/{src/{{main,test}/{java,resources},docs},libs}
echo """
# README

This project is ${PROJECT_NAME}.

by ${GIT_AUTHOR_NAME} <${GIT_AUTHOR_EMAIL}>

""" | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/README.md
echo "target/" | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/.gitignore
echo "java=${JAVA_VERSION}" | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/.sdkmanrc
curl -sL https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.12.2/junit-platform-console-standalone-1.12.2.jar > "${PROJECT_NAME}"/libs/junit-platform-console-standalone-1.12.2.jar
curl -sL https://gist.githubusercontent.com/mcgivrer/b95bf476b8494c180c0a386a5ae11264/raw/0618c582240ec4972fad844c884d28df086ab674/build > "${PROJECT_NAME}"/build

# integrate VSCode support
mkdir -p "${PROJECT_NAME}/.vscode";\
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}/.vscode/settings.json"
{
    "java.format.settings.url": ".vscode/java-formatter.xml",
    "java.project.sourcePaths": [
        "src\\main\\java",
        "src\\main\\resources",
        "src\\test\\java",
        "src\\test\\resources"
    ],
    "java.project.encoding": "warning",
    "java.project.referencedLibraries": [
        "libs\\junit-platform-console-standalone-1.12.2.jar"
    ],
    "java.project.outputPath": "target\\classes"
}
EOL
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}/.vscode/launch.json"
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "type": "java",
            "name": "Current File",
            "request": "launch",
            "mainClass": "${file}"
        },
        {
            "type": "java",
            "name": "App",
            "request": "launch",
            "mainClass": "App",
            "projectName": "${PROJECT_NAME}_53c24221"
        }
    ]
}
EOL
# create documentation
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/src/docs/00-preface.md
# Project ${PROJECT_NAME}

## Preface

This is the preface for the documentation of the project ${PROJECT_NAME}.
You must rewrite this document according to your specifications.

>[!NOTE]
>Please us the markdown text format to easily create 
>docs in multiple format with the 'pandoc' tool. 

${GIT_AUTHOR_NAME} ${GIT_AUTHOR_EMAIL}
EOL
# create configuration file
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/src/main/resources/config.properties
app.debug=0
app.mode=DEVELOPMENT
EOL
# create translation file
mkdir -p "${PROJECT_NAME}"/src/main/resources/i18n
cat <<EOL | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/src/main/resources/i18n/messages.properties
app.name=${PROJECT_NAME}
app.version=1.0.0
EOL

# create a basic application class into a core package.

mkdir -p "${PROJECT_NAME}"/src/main/java/${PACKAGE_NAME//.//}
# Générer le fichier en utilisant envsubst
if [[ -n "${FRAME}" ]]; then
    envsubst < ~/scripts/templates/App_Frame_template.java | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/src/main/java/${PACKAGE_NAME//.//}/${MAIN_CLASS_NAME}.java
else
    envsubst < ~/scripts/templates/App_template.java | iconv -f UTF-8 -t UTF-8 > "${PROJECT_NAME}"/src/main/java/${PACKAGE_NAME//.//}/${MAIN_CLASS_NAME}.java
fi

## create git repository
git init -b main --quiet "${PROJECT_NAME}"/
git -C "${PROJECT_NAME}" config user.name "${GIT_AUTHOR_NAME}"
git -C "${PROJECT_NAME}" config user.email "${GIT_AUTHOR_EMAIL}"
git -C "${PROJECT_NAME}" add .
git -C "${PROJECT_NAME}" commit -m "Create Project ${PROJECT_NAME}"

# Pousser vers le dépôt distant si l'URL est fournie
if [[ -n "${REMOTE_REPO_URL}" ]]; then
    git -C "${PROJECT_NAME}" remote add origin "${REMOTE_REPO_URL}"
    git -C "${PROJECT_NAME}" push -f origin main
fi
