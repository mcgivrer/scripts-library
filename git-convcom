#!/usr/bin/env bash
set -euo pipefail

# git-convcom : aide à la création de Conventional Commits
# Usage:
#   git convcom [type] [scope] [--] [-m "short"]    # non-interactive possible
#   git convcom                                     # interactive

TYPES=(feat fix docs style refactor perf test chore build ci)
# description max length suggestion
SUBJECT_MAX=72

# helper: check in a git repo
in_git_repo() {
  git rev-parse --is-inside-work-tree >/dev/null 2>&1
}

# build full message and commit
do_commit() {
  local type="$1" scope="$2" subject="$3" body="$4" footer="$5"
  local header
  if [[ -n "$scope" ]]; then
    header="$type($scope): $subject"
  else
    header="$type: $subject"
  fi

  # show and confirm
  echo "----- commit message -----"
  echo "$header"
  echo
  [[ -n "$body" ]] && echo "$body" && echo
  [[ -n "$footer" ]] && echo "$footer" && echo
  echo "--------------------------"

  read -r -p "Commit with this message? [y/N] " ans
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    git add -A
    git commit -m "$header" -m "$body" || true
    # If footer exists, append as note or separate commit message line
    if [[ -n "$footer" ]]; then
      # add footer as separate paragraph (already added via -m above if non-empty)
      true
    fi
    echo "Committed."
  else
    echo "Aborted."
    exit 1
  fi
}

# open editor for multi-line body (uses VISUAL/EDITOR)
edit_text() {
  local tmp
  tmp="$(mktemp)"
  "${VISUAL:-${EDITOR:-vi}}" "$tmp"
  sed -n '/./p' "$tmp" || true  # print non-empty lines
  cat "$tmp"
  rm -f "$tmp"
}

# interactive flow
interactive() {
  echo "Conventional Commit assistant"

  # choose type
  echo "Type (use number or name) :"
  local i
  for i in "${!TYPES[@]}"; do
    printf "  %2d) %s\n" $((i+1)) "${TYPES[i]}"
  done
  read -r -p "> " type_in
  if [[ "$type_in" =~ ^[0-9]+$ ]]; then
    type="${TYPES[$((type_in-1))]:-}"
  else
    type="$type_in"
  fi
  if [[ -z "$type" || ! " ${TYPES[*]} " =~ " ${type} " ]]; then
    echo "Type invalide." >&2
    exit 1
  fi

  # scope (optional)
  read -r -p "Scope (optionnel) : " scope

  # subject (short)
  read -e -p "Subject (court) : " subject
  if (( ${#subject} > SUBJECT_MAX )); then
    echo "Warning: subject > $SUBJECT_MAX chars (${#subject})."
  fi

  # body (open editor)
  echo "Editer le corps du message (laisser vide pour none). Le fichier s'ouvrira dans \$EDITOR."
  read -r -p "Ouvrir l'éditeur ? [Y/n] " edityn
  body=""
  if [[ -z "$edityn" || "$edityn" =~ ^[Yy]$ ]]; then
    body="$(edit_text)"
  fi

  # footer (e.g. BREAKING CHANGE, closes #123)
  read -r -p "Footer (optionnel) : " footer

  do_commit "$type" "$scope" "$subject" "$body" "$footer"
}

# non-interactive: positional args
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  cat <<EOF
Usage:
  git convcom            # interactive
  git convcom <type> <scope?>  # non-interactive: will prompt subject/body/editor
EOF
  exit 0
fi

if ! in_git_repo; then
  echo "Not inside a git repository." >&2
  exit 1
fi

if [[ $# -ge 1 ]]; then
  # accept: git convcom type scope
  type="$1"
  scope="${2:-}"
  echo "Subject (short) :"
  read -r subject
  echo "Ouvrir éditeur pour le corps ?"
  read -r yn
  body=""
  if [[ -z "$yn" || "$yn" =~ ^[Yy]$ ]]; then
    body="$(edit_text)"
  fi
  footer=""
  do_commit "$type" "$scope" "$subject" "$body" "$footer"
else
  interactive
fi
